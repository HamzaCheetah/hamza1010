{%- comment -%}
Wishlist Popup (no app) — centered modal with real Shopify Add to Cart buttons
- Depends on heart buttons with class .js-wishlist-toggle on product cards
- Hidden Shopify forms are used for Add to Cart
{%- endcomment -%}


<div id="wl-product-forms" style="display: none;">
  {%- assign wishlist_handles = '' | split: ',' -%}
  {%- for handle in wishlist_handles -%}
    {% assign p = all_products[handle] %}
    {% if p %}
      <div class="wl-product-form-wrapper" data-handle="{{ handle }}">
        {% render 'buy-buttons', product: p, section_id: section.id, product_form_id: "wl-form-" | append: handle %}
      </div>
    {% endif %}
  {%- endfor -%}
</div>

{%- comment -%} Wishlist modal {%- endcomment -%}
<div id="wl-backdrop" class="wl-backdrop" hidden></div>

<div id="wl-modal" class="wl-modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="wl-title">
  <div class="wl-panel" role="document">
    <header class="wl-header">
      <h2 id="wl-title">My Wishlist ❤️</h2>
      <button type="button" class="wl-close" data-wl-close aria-label="Close">&times;</button>
    </header>
    <section id="wl-items" class="wl-items" aria-live="polite"></section>
  </div>
</div>

<script>
(function(){
  const TOGGLE_SELECTOR = '.js-wishlist-toggle, .wl-heart'; 
  const KEY = 'wl_v1';
  const modal = document.getElementById('wl-modal');
  const backdrop = document.getElementById('wl-backdrop');
  const itemsEl = document.getElementById('wl-items');
  const moneyFormat = {{ shop.money_format | json }};

  const getList = () => { 
    try { return JSON.parse(localStorage.getItem(KEY)) || []; } 
    catch(e){ return []; } 
  };
  const setList = (arr) => { 
    const out = Array.from(new Set(arr)); 
    localStorage.setItem(KEY, JSON.stringify(out)); 
    return out; 
  };

  function formatMoney(cents){
    try { if (window.Shopify && Shopify.formatMoney) return Shopify.formatMoney(cents, moneyFormat); } catch(e){}
    return (Number(cents||0)/100).toFixed(2);
  }

  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));

  function updateWishlistBadge(){
    const list = getList();
    document.querySelectorAll('[data-wishlist-count]').forEach(el => {
      el.textContent = list.length;
      el.classList.toggle('wl-badge--visible', list.length > 0);
    });
    document.querySelectorAll('.wl-header-heart .wl-icon').forEach(svg => {
      svg.classList.toggle('active', list.length > 0);
    });
    document.querySelectorAll('.js-open-wl').forEach(btn => {
      btn.setAttribute('aria-label', list.length > 0 ? `Open wishlist (${list.length})` : 'Open wishlist');
    });
  }

  function syncHearts(handle){
    const list = getList();
    const sel = handle ? `${TOGGLE_SELECTOR}[data-handle="${handle}"]` : TOGGLE_SELECTOR;
    document.querySelectorAll(sel).forEach(a => {
      const active = list.includes(a.dataset.handle);
      a.classList.toggle('is-active', active);
      a.setAttribute('aria-pressed', active ? 'true' : 'false');
      const svg = a.querySelector('.wishlist-icon'); 
      if (svg) svg.classList.toggle('active', active); 
    });
    updateWishlistBadge();
  }

  const isOpen = () => modal && modal.classList.contains('is-open');

  function openModal(){
    if (!modal) return;
    renderList();
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden', 'false');
    backdrop.hidden = false;
    document.documentElement.classList.add('wl-no-scroll');
    document.querySelectorAll('.js-open-wl').forEach(b => b.setAttribute('aria-expanded','true'));
  }

  function closeModal(){
    if (!modal) return;
    if (document.activeElement && modal.contains(document.activeElement)) document.activeElement.blur();
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
    backdrop.hidden = true;
    document.documentElement.classList.remove('wl-no-scroll');
    document.querySelectorAll('.js-open-wl').forEach(b => b.setAttribute('aria-expanded','false'));
  }

  async function renderList(){
    const handles = getList();
    if (!handles.length){
      itemsEl.innerHTML = '<p class="wl-empty">Your wishlist is empty ❤️</p>';
      return;
    }

    itemsEl.innerHTML = '';

    for (const handle of handles){
      const pData = await fetch(`/products/${handle}.js`).then(r => r.ok ? r.json() : null).catch(()=>null);
      if (!pData) continue;

      const img = (pData.images && pData.images[0]) || '//cdn.shopify.com/s/images/admin/no-image-compact.gif';
      const priceCents = pData.price ?? pData.price_min ?? (pData.variants && pData.variants[0]?.price) ?? 0;
      const price = formatMoney(priceCents);

      // Get hidden Shopify form for this product
      const formHtml = document.querySelector(`#wl-product-forms .wl-product-form-wrapper[data-handle="${handle}"]`)?.innerHTML || '';

      itemsEl.insertAdjacentHTML('beforeend', `
        <article class="wl-card" data-handle="${handle}">
          <a class="wl-thumb" href="/products/${handle}">
            <img src="${img}" alt="${escapeHtml(pData.title)}">
          </a>
          <div class="wl-info">
            <a class="wl-title" href="/products/${handle}">${escapeHtml(pData.title)}</a>
            <div class="wl-price">${price}</div>
            <div class="wl-actions">
              ${formHtml || `<a class="wl-btn wl-btn--secondary" href="/products/${handle}">View</a>`}
              <button type="button" class="wl-btn wl-btn--light js-wl-remove" data-handle="${handle}">Remove</button>
            </div>
          </div>
        </article>
      `);
    }
  }

  document.addEventListener('click', (e) => {
    const heart = e.target.closest(TOGGLE_SELECTOR);
    if (heart){
      e.preventDefault();
      const handle = heart.dataset.handle;
      if (!handle) return;
      let list = getList();
      list = list.includes(handle) ? list.filter(h => h !== handle) : [...list, handle];
      setList(list);
      syncHearts(handle);
      if (isOpen()) renderList();
      return;
    }

    if (e.target.closest('.js-open-wl')) { e.preventDefault(); openModal(); return; }
    if (e.target === backdrop || e.target.closest('[data-wl-close]')) { closeModal(); return; }

    const rem = e.target.closest('.js-wl-remove');
    if (rem){
      const h = rem.dataset.handle;
      setList(getList().filter(x => x !== h));
      syncHearts(h);
      updateWishlistBadge();
      renderList();
      return;
    }
  });

  document.addEventListener('keydown', (e) => { 
    if (e.key === 'Escape' && isOpen()) closeModal(); 
  });

  syncHearts();
  document.addEventListener('shopify:section:load', () => syncHearts()); 
})();
</script>
